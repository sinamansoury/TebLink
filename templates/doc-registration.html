{% extends 'layout.html' %}
{% block title %}ูุฑูุฏ ูพุฒุดฺฉุงู{% endblock %}
{% block content %}

    <!-- ุตูุญู ูุฑูุฏ ู ุชุงุฏ OTP -->
    <div id="otp-page" class="flex items-center justify-center mt-10">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md" >
            <h2 class="text-2xl font-bold text-center text-blue-600 mb-6" >ูุฑูุฏ ูพุฒุดฺฉุงู</h2>

            <form id="otp-form">
                {% csrf_token %}
                <div class="mb-4">
                    <label class="block font-bold text-black " dir="rtl">ุดูุงุฑู ููุจุงู</label>
                    <input type="tel" id="phone-number" class="w-full p-2 border rounded-lg" required>
                </div>

                <button type="button" id="send-otp" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">
                    ุงุฑุณุงู ฺฉุฏ
                </button>

                <div id="otp-section" class="mt-4 hidden">
                    <label class="block font-bold text-black" dir="rtl">ฺฉุฏ ุชุฃุฏ</label>
                    <div class="flex gap-2 justify-center">
                        <input type="text" maxlength="1" class="otp-box w-10 text-center border rounded-lg p-2 text-lg font-bold" dir="ltr" required>
                        <input type="text" maxlength="1" class="otp-box w-10 text-center border rounded-lg p-2 text-lg font-bold" dir="ltr" required>
                        <input type="text" maxlength="1" class="otp-box w-10 text-center border rounded-lg p-2 text-lg font-bold" dir="ltr" required>
                        <input type="text" maxlength="1" class="otp-box w-10 text-center border rounded-lg p-2 text-lg font-bold" dir="ltr" required>
                        <input type="text" maxlength="1" class="otp-box w-10 text-center border rounded-lg p-2 text-lg font-bold" dir="ltr" required>
                    </div>


                    <button type="submit" class="w-full mt-4 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">
                        ุชุฃุฏ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ุตูุญู ุซุจุชโูุงู ูพุฒุดฺฉุงู -->
    <div id="register-page" class="flex items-center justify-center mt-10 hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-3xl" dir="rtl">
            <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">ูุฑู ุซุจุชโูุงู ูพุฒุดฺฉุงู</h2>

            <form id="doctor-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-bold text-black">ูุงู</label>
                        <input type="text" id="first-name" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block font-bold text-black">ูุงู ุฎุงููุงุฏฺฏ</label>
                        <input type="text" id="last-name" class="w-full p-2 border rounded-lg" required>
                    </div>

                    <div>
                        <label class="block font-bold text-black">ฺฉุฏ ูู</label>
                        <input type="text" id="national-id" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block font-bold text-black">ุชุงุฑุฎ ุชููุฏ</label>
                        <input type="date" id="birth-date" class="w-full p-2 border rounded-lg" required>
                    </div>

                    <div>
                        <label class="block font-bold text-black">ุดูุงุฑู ูุธุงู ูพุฒุดฺฉ</label>
                        <input type="text" id="medical-id" class="w-full p-2 border rounded-lg" required>
                    </div>

                    <div>
                        <label class="block font-bold text-black">ุฌูุณุช</label>
                        <select id="gender" class="w-full p-2 border rounded-lg" required>
                            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
                            <option value="male">ูุฑุฏ</option>
                            <option value="female">ุฒู</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-bold text-black">ูุฏุฑฺฉ ุชุญุตู</label>
                        <select id="degree" class="w-full p-2 border rounded-lg" required>
                            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block font-bold text-black">ุชุฎุตุต</label>
                        <select id="specialty" class="w-full p-2 border rounded-lg" required>
                            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
                            <!-- ุชุฎุตุตโูุง ุจู ุตูุฑุช ุฏุงูุงูฺฉ ุงุถุงูู ูโุดููุฏ -->
                        </select>
                    </div>
                </div>

                <button type="submit" class="w-full mt-6 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">
                    ุซุจุชโูุงู
                </button>
            </form>
        </div>
    </div>
    <script>
        function getCSRFToken() {
            let csrfToken = null;
            document.cookie.split(';').forEach(function (cookie) {
                if (cookie.trim().startsWith('csrftoken=')) {
                    csrfToken = cookie.trim().substring('csrftoken='.length);
                }
            });
            return csrfToken;
        }
        document.addEventListener("DOMContentLoaded", function () {
            fetch('/api/degree/')
                .then(response => response.json())
                .then(data => {
                    const degreeSelect = document.getElementById('degree');

                    // ุงุถุงูู ฺฉุฑุฏู ฺฏุฒููโูุง ุฏุฑุงูุช ุดุฏู ุจู dropdown
                    data.forEach(degree => {  // ุฏุงุฏูโูุง ุจู ุตูุฑุช ูุณุชูู ูุณุช ูุณุชูุฏ
                        const option = document.createElement('option');
                        option.value = degree.id; // ุง ูุฑ ฺุฒ ฺฉู ุจุฑุง value ูุงุฒู ุฏุงุฑุฏ
                        option.textContent = degree.name;
                        degreeSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("ุฎุทุง ุฏุฑ ุฏุฑุงูุช ุฏุงุฏูโูุง:", error);
                });
        });
        document.getElementById("degree").addEventListener("change", function () {
    const degreeId = this.value;

    if (degreeId) {
        fetch(`/api/specialty/${degreeId}/`)
            .then(response => response.json())
            .then(data => {
                const specialtySelect = document.getElementById("specialty");
                specialtySelect.innerHTML = '<option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>';  // ูพุงฺฉ ฺฉุฑุฏู ุชุฎุตุตโูุง ูุจู

                // ุงุถุงูู ฺฉุฑุฏู ุชุฎุตุตโูุง ุฌุฏุฏ ุจู dropdown
                data.forEach(specialty => {
                    const option = document.createElement('option');
                    option.value = specialty.id;
                    option.textContent = specialty.name;
                    specialtySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("ุฎุทุง ุฏุฑ ุฏุฑุงูุช ุชุฎุตุตโูุง:", error);
            });
    } else {
        // ุงฺฏุฑ ูุฏุฑฺฉ ุงูุชุฎุงุจ ูุดุฏู ุจูุฏุ ููุฏ ุชุฎุตุต ุฑุง ุฎุงู ฺฉูุฏ
        document.getElementById("specialty").innerHTML = '<option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>';
    }
});


        document.addEventListener("DOMContentLoaded", function () {
            const otpInputs = document.querySelectorAll(".otp-box");

            otpInputs.forEach((input, index) => {
                input.addEventListener("input", (e) => {
                    if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus(); // ุฑูุชู ุจู ููุฏ ุจุนุฏ
                    }
                });

                input.addEventListener("keydown", (e) => {
                    if (e.key === "Backspace" && input.value.length === 0 && index > 0) {
                        otpInputs[index - 1].focus(); // ุจุงุฒฺฏุดุช ุจู ููุฏ ูุจู
                    }
                });
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            const phoneInput = document.getElementById("phone-number");
            const sendOtpBtn = document.getElementById("send-otp");
            const otpInputs = document.querySelectorAll(".otp-box");
            const otpForm = document.getElementById("otp-form");
            const doctorForm = document.getElementById("doctor-form");

            let phoneNumber = "";

            // ๐ ุงุฑุณุงู ุดูุงุฑู ููุจุงู ุจุฑุง ุฏุฑุงูุช ุง ุชุฃุฏ OTP
            sendOtpBtn.addEventListener("click", function () {
                phoneNumber = phoneInput.value.trim();

                if (!phoneNumber || phoneNumber.length !== 11 || !/^09\d{9}$/.test(phoneNumber)) {
                    alert("ูุทูุงู ฺฉ ุดูุงุฑู ููุจุงู ูุนุชุจุฑ ูุงุฑุฏ ฺฉูุฏ.");
                    return;
                }

                fetch("/api/doctor/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()},
                    body: JSON.stringify({ phone: phoneNumber, step: "send_otp" })  // ุงุฑุณุงู ุฏุฑุฎูุงุณุช OTP
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById("otp-section").classList.remove("hidden");
                            otpInputs[0].focus();
                        } else {
                            alert(data.message || "ุงุฑุณุงู OTP ูุงูููู ุจูุฏ.");
                        }
                    })
                    .catch(error => console.error("ุฎุทุง ุฏุฑ ุงุฑุณุงู OTP:", error));
            });

            // ๐ ุชุฃุฏ OTP
            otpForm.addEventListener("submit", function (event) {
                event.preventDefault();

                let otpCode = Array.from(otpInputs).map(input => input.value.trim()).join("");
                if (otpCode.length !== 5) {
                    alert("ูุทูุงู ฺฉุฏ ุชุฃุฏ ต ุฑูู ุฑุง ูุงุฑุฏ ฺฉูุฏ.");
                    return;
                }

                fetch("/api/doctor/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()},
                    body: JSON.stringify({ phone: phoneNumber, otp: otpCode, step: "verify_otp" })  // ุชุฃุฏ OTP
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById("otp-page").classList.add("hidden");
                            document.getElementById("register-page").classList.remove("hidden");
                        } else {
                            alert("ฺฉุฏ ุชุฃุฏ ุงุดุชุจุงู ุงุณุช. ูุทูุงู ูุฌุฏุฏุงู ุชูุงุด ฺฉูุฏ.");
                            otpInputs.forEach(input => input.value = "");  // ูพุงฺฉ ฺฉุฑุฏู ููุฏูุง OTP

                        }
                    })
                    .catch(error => console.error("ุฎุทุง ุฏุฑ ุชุงุฏ OTP:", error));
            });

            // ๐ ุงุฑุณุงู ุงุทูุงุนุงุช ุซุจุชโูุงู ูพุฒุดฺฉ
            doctorForm.addEventListener("submit", function (event) {
                event.preventDefault();

                const formData = {
                    phone: phoneNumber,
                    first_name: document.getElementById("first-name").value.trim(),
                    last_name: document.getElementById("last-name").value.trim(),
                    national_id: document.getElementById("national-id").value.trim(),
                    birth_date: document.getElementById("birth-date").value.trim(),
                    medical_id: document.getElementById("medical-id").value.trim(),
                    gender: document.getElementById("gender").value,
                    degree: document.getElementById("degree").value,
                    specialty: document.getElementById("specialty").value,
                    step: "register"
                };

                fetch("/api/doctor/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()},
                    body: JSON.stringify(formData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("ุซุจุชโูุงู ุจุง ููููุช ุงูุฌุงู ุดุฏ!");
                            window.location.href = "/";
                        } else {
                            alert(data.message || "ุซุจุชโูุงู ูุงูููู ุจูุฏ.");
                        }
                    })
                    .catch(error => console.error("ุฎุทุง ุฏุฑ ุซุจุชโูุงู:", error));
            });
        });


    </script>



{% endblock %}
